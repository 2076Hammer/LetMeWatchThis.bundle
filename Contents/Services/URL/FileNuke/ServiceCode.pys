import re, stringfrom BeautifulSoup import BeautifulSoupUSER_AGENT = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_2) AppleWebKit/534.51.22 (KHTML, like Gecko) Version/5.1.1 Safari/534.51.22'def NormalizeURL(url):	#Log("*********** In MovPod / DaClips / GorillaVid normalizeURL")	# Deal with special providerInfo URL built up by plugin to return	# info about this provider. For all other normal URLs, do nothing. 	if ("providerinfo" in url):			# Extract out domain.		match = re.search("(filenuke)", url.lower())		if (match is None):			return url			try:			show = Prefs["show_" + match.group(1)]		except Exception, ex:			show = False					if (show):			return url + "&supported=true"		else:			return url				else:		return url		def MetadataObjectForURL(url): 	#Log('In MetadataObjectForURL for MovPod / DaClips (' + url + ')')		video = VideoClipObject(		title = 'FileNuke Redirect Page',		summary = 'FileNuke Redirect Page',		thumb = None,	)		return videodef MediaObjectsForURL(url):	ret = []	ret.append(		MediaObject(			parts = [PartObject(key=Callback(PlayVideo, url=url))],		)	)	  	return ret@indirectdef PlayVideo(url):	HTTP.Headers['User-Agent'] = USER_AGENT		# Request Initial Provider page.	try:		#Log('Requesting ' + url)		soup = BeautifulSoup(HTTP.Request(url).content)			except Exception, ex:		return LogProviderError("Error whilst retrieving initial provider page (" + url + ")", ex)			# Extract out these form elements if present...	try:		formElems = ['op', 'id', 'fname', 'method_free', 'referer', 'usr_login']		params = {}				for formElem in formElems:			formElemVal =  soup.find('input', {'name' : formElem })['value']			params[formElem] = formElemVal				except Exception, ex:		return LogProviderError("Error whilst extracting out form elemnts to navigate to 2nd page.",ex)		# Navigate to 2nd page.	try:		contents = HTTP.Request(url, values=params, headers={ 'Referer': url }, cacheTime=0).content		soup = BeautifulSoup(contents)		except Exception, ex:		return LogProviderError("Error whilst retrieving second provider page (" + url + ")", ex)				# Extract out JS packed final video URL.	script_elems = soup.find('div', { 'id': 'player_code' }).findAll('script')	elems = None	url = None	for script_elem in script_elems:			script = script_elem.string		if script is None:			continue					Log(script)			# Look for substitution values.		sub_vals = re.search("\d{2},'([^']*)'.split", script)		if (sub_vals is None):			continue				elems = sub_vals.group(1).split('|')		Log(elems)			# Look for url to substitute values into.		url_re = re.search("([0-9a-z]://[0-9a-z]\.[0-9a-z]\.[0-9a-z]\.[0-9a-z]/[0-9a-z]/[0-9a-z]/[0-9a-z]\.[0-9a-z])", script)		Log(url_re.group(1))				if (url_re is None or url_re.group(1) is None):			continue				url = url_re.group(1)	if (elems is None or url is None):		return LogProviderError("Error whilst extracting out / depacking video URL elements", None)			# Create dict to map url sub keys to sub values.	alphadict = dict()	for index_cnt in range(0, 2):		index = index_cnt * len(string.digits + string.ascii_lowercase)		strindex = str(index_cnt) if index_cnt > 0 else ""		for cnt in range(0, len(string.digits + string.ascii_lowercase)):			alphadict[strindex + (string.digits + string.ascii_lowercase)[cnt]] = cnt + index		def SubElem(matchObj):		val = elems[alphadict[matchObj.group(0)]]		if (val == ""):			val = matchObj.group(0)		return val	# Sub values into url to get final url.	final_url = re.sub("[0-9a-z]{1,2}", SubElem, url) 	Log(final_url)		oc = ObjectContainer(		objects = [			VideoClipObject(				items = [					MediaObject(						parts = [PartObject(key=final_url)]					)				]			)		]	)	# Might as well set a sensible user agent string.	oc.user_agent = USER_AGENT		return oc		def LogProviderError(msg="", ex=None):	Log("************************** PROVIDER ERROR: " + msg)	return []