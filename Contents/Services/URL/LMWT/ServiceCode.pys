import reimport urlparseimport cgiimport base64import urllib2from datetime import dateUSER_AGENT = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_2) AppleWebKit/534.51.22 (KHTML, like Gecko) Version/5.1.1 Safari/534.51.22'PLEX_URL = "http://127.0.0.1:32400"PLUGIN_URL = PLEX_URL + "/video/lmwt"def NormalizeURL(url):	return url	def MetadataObjectForURL(url): 	Log('In MetadataObjectForURL for LMWT (' + url + ')')		video = None		# Plugin should have access to info about this URL if user used plugin to launch video.	# Bad things can happen here. Still want to run rest of code if possible though...	try:		request = urllib2.Request(PLUGIN_URL + "/mediainfo/%s" % String.Encode(url))		mediainfo = JSON.ObjectFromString(urllib2.urlopen(request).read())				#Log(mediainfo)				video = VideoClipObject(			title=mediainfo['title'],			summary=mediainfo['summary'],			art=mediainfo['background'],			thumb= mediainfo['poster'],			rating = float(mediainfo['rating']),			duration=mediainfo['duration'],			year=mediainfo['year'],			originally_available_at= (				date.fromordinal(mediainfo['release_date'])				if ('release_date' in mediainfo and mediainfo['release_date'])  else None			),			genres=mediainfo['genres'],		)			except Exception, ex:		Log(ex)			#Log(video)	if video is None:			# Return bare minimum. This is never shown to users.		video = VideoClipObject(			title = 'LMWT Redirect Page',			summary = 'LMWT Redirect Page',			thumb = None,		)		return videodef MediaObjectsForURL(url):	#Log('In MediaObjectsForURL for LMWT')		ret = []	ret.append(		MediaObject(			parts = [PartObject(key=Callback(PlayVideo, url=url))],		)	)	  	return ret@indirectdef PlayVideo(url):	# Extract out and break down query string of the LMWT Provider URL...	lmwt_qs_args = cgi.parse_qs(urlparse.urlparse(url).query)		# Extract out provider URL	provider_url = base64.b64decode(lmwt_qs_args['url'][0])		media_objects = URLService.MediaObjectsForURL(provider_url)		if (len(media_objects) > 0):		PlaybackStarted(url=url)			return ObjectContainer(		objects = [			VideoClipObject(				items = media_objects			)		]	)		################################################################################################### LMWT Plugin specific helper methods.def PlaybackStarted(url):		# Bad things can happen here. Let's try to be neat though....	try:			caller = "lmwt"				# We may be playing the video on behalf of another plugin. In that case, we'll need to		# call that plugin's PlaybackStarted method insted of our own.		#		# Check if this is the case by seeing who originally called for the source listing.		try:			request = urllib2.Request(				PLUGIN_URL + "/playback/caller/" + String.Encode(url)			)			response = JSON.ObjectFromString(urllib2.urlopen(request).read())			if (response['caller']):				caller = response['caller']		except Exception, ex:			pass				# Get the media info object that was built by this plugin when generating the		#Â source listing. We'll use the info in that to talk to whatever plugin we need to		# tell the item has started playing. 		request = urllib2.Request(PLUGIN_URL + "/mediainfo/" + String.Encode(url))		mediainfo = JSON.ObjectFromString(urllib2.urlopen(request).read())				# Use the information from the mediainfo to call the PlaybackStarted method of		# whatever plugin requested this.		url = PLEX_URL + '/video/' + caller + "/playback/%s" % mediainfo['id']				if (mediainfo['ep_num']):			url += "/" + str(mediainfo['season']) + "/" + str(mediainfo['ep_num'])		Log(url)				request = urllib2.Request(url)		response = urllib2.urlopen(request)			except Exception, ex:		Log.Exception("Error whilst trying to mark item as played")		pass